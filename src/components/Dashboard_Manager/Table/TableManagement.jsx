import React, { useState, useEffect, useCallback } from "react";
import Modal from "../../../components/common/Modal";
import Button from "../../../components/common/Button";
import Card from "../../../components/common/Card";
import Notification from "../../../components/common/Notification";
import OrderModal from "./OrderModal";
import "./TableManagement.scss";

const TableManagement = () => {
  // State management
  const [floors, setFloors] = useState([
    {
      id: 1,
      name: "T·∫ßng tr·ªát",
      icon: "üè¢",
      description: "Khu v·ª±c ch√≠nh",
      active: true,
    },
    {
      id: 2,
      name: "T·∫ßng 1",
      icon: "1Ô∏è‚É£",
      description: "Khu v·ª±c VIP",
      active: false,
    },
    {
      id: 3,
      name: "S√¢n th∆∞·ª£ng",
      icon: "üå≥",
      description: "Khu v·ª±c ngo√†i tr·ªùi",
      active: false,
    },
    {
      id: 4,
      name: "Mang v·ªÅ",
      icon: "üì¶",
      description: "ƒê∆°n h√†ng mang v·ªÅ",
      active: false,
    },
  ]);

  const [tables, setTables] = useState([
    {
      id: 1,
      number: "B01",
      seats: 4,
      status: "available",
      floorId: 1,
      area: "indoor",
      customer: null,
      orderTime: null,
      total: 0,
      orders: [],
      entryTime: null,
      guestCount: 0,
      x: 100,
      y: 100,
    },
    {
      id: 2,
      number: "B02",
      seats: 2,
      status: "occupied",
      floorId: 1,
      area: "indoor",
      customer: "Nguy·ªÖn VƒÉn A",
      orderTime: "19:30",
      total: 450000,
      orders: [
        {
          item: "Ph·ªü B√≤ T√°i",
          quantity: 2,
          price: 65000,
          subtotal: 130000,
          cookingMethod: "T√°i ch√≠n",
          customMethod: "",
        },
        {
          item: "Tr√† ƒê√°",
          quantity: 2,
          price: 5000,
          subtotal: 10000,
          cookingMethod: "",
          customMethod: "",
        },
      ],
      entryTime: "19:15",
      guestCount: 2,
      x: 250,
      y: 100,
    },
    {
      id: 3,
      number: "B03",
      seats: 6,
      status: "reserved",
      floorId: 1,
      area: "indoor",
      customer: "Tr·∫ßn Th·ªã B",
      orderTime: "20:00",
      total: 0,
      orders: [],
      entryTime: null,
      guestCount: 4,
      x: 400,
      y: 100,
    },
    {
      id: 4,
      number: "B04",
      seats: 4,
      status: "cleaning",
      floorId: 1,
      area: "indoor",
      customer: null,
      orderTime: null,
      total: 0,
      orders: [],
      entryTime: null,
      guestCount: 0,
      x: 100,
      y: 250,
    },
    {
      id: 5,
      number: "B05",
      seats: 8,
      status: "available",
      floorId: 1,
      area: "vip",
      customer: null,
      orderTime: null,
      total: 0,
      orders: [],
      entryTime: null,
      guestCount: 0,
      x: 250,
      y: 250,
    },
    {
      id: 6,
      number: "V01",
      seats: 2,
      status: "occupied",
      floorId: 2,
      area: "vip",
      customer: "L√™ VƒÉn C",
      orderTime: "18:45",
      total: 850000,
      orders: [
        {
          item: "B√≤ Wagyu N∆∞·ªõng",
          quantity: 1,
          price: 500000,
          subtotal: 500000,
          cookingMethod: "Medium",
          customMethod: "√çt mu·ªëi",
        },
        {
          item: "R∆∞·ª£u Vang ƒê·ªè",
          quantity: 1,
          price: 350000,
          subtotal: 350000,
          cookingMethod: "",
          customMethod: "",
        },
      ],
      entryTime: "18:30",
      guestCount: 2,
      x: 150,
      y: 150,
    },
    {
      id: 7,
      name: "ST01",
      seats: 4,
      status: "available",
      floorId: 3,
      area: "outdoor",
      customer: null,
      orderTime: null,
      total: 0,
      orders: [],
      entryTime: null,
      guestCount: 0,
      x: 200,
      y: 200,
    },
    {
      id: 8,
      name: "TO01",
      seats: 0,
      status: "occupied",
      floorId: 4,
      area: "takeaway",
      customer: "Ph·∫°m VƒÉn D",
      orderTime: "19:45",
      total: 125000,
      orders: [
        {
          item: "C∆°m G√† X·ªëi M·ª°",
          quantity: 2,
          price: 45000,
          subtotal: 90000,
          cookingMethod: "Cay v·ª´a",
          customMethod: "",
        },
        {
          item: "N∆∞·ªõc Ng·ªçt",
          quantity: 2,
          price: 15000,
          subtotal: 30000,
          cookingMethod: "",
          customMethod: "",
        },
      ],
      entryTime: "19:45",
      guestCount: 0,
      x: 0,
      y: 0,
    },
  ]);
  const [deliveryPartners] = useState([
    {
      id: 1,
      name: "Grab Food",
      logo: "üü¢",
      status: "online",
      commission: "20%",
      currentOrders: 3,
      totalOrders: 45,
      rating: 4.8,
      description: "N·ªÅn t·∫£ng giao h√†ng h√†ng ƒë·∫ßu",
    },
    {
      id: 2,
      name: "Shopee Food",
      logo: "üî∂",
      status: "online",
      commission: "18%",
      currentOrders: 2,
      totalOrders: 32,
      rating: 4.6,
      description: "Giao h√†ng nhanh, nhi·ªÅu ∆∞u ƒë√£i",
    },
    {
      id: 3,
      name: "Baemin",
      logo: "üî¥",
      status: "offline",
      commission: "22%",
      currentOrders: 0,
      totalOrders: 28,
      rating: 4.5,
      description: "D·ªãch v·ª• giao h√†ng H√†n Qu·ªëc",
    },
    {
      id: 4,
      name: "GoFood",
      logo: "üü°",
      status: "online",
      commission: "19%",
      currentOrders: 1,
      totalOrders: 38,
      rating: 4.7,
      description: "Giao h√†ng t·ª´ Gojek",
    },
  ]);
  const [menuItems] = useState({
    main: [
      {
        id: 1,
        name: "Ph·ªü B√≤ T√°i",
        price: 65000,
        category: "main",
        description: "Ph·ªü b√≤ truy·ªÅn th·ªëng v·ªõi th·ªãt b√≤ t√°i",
        cookingMethods: [
          { name: "T√°i", price: 65000, description: "Th·ªãt b√≤ t√°i m·ªÅm" },
          {
            name: "T√°i ch√≠n",
            price: 70000,
            description: "Th·ªãt b√≤ t√°i v√† ch√≠n",
          },
          { name: "Ch√≠n", price: 68000, description: "Th·ªãt b√≤ ch√≠n ho√†n to√†n" },
          { name: "T√°i g√¢n", price: 75000, description: "Th·ªãt b√≤ t√°i v·ªõi g√¢n" },
        ],
        hasWeight: false,
      },
      {
        id: 2,
        name: "B√∫n B√≤ Hu·∫ø",
        price: 55000,
        category: "main",
        description: "B√∫n b√≤ Hu·∫ø cay n·ªìng ƒë·∫∑c tr∆∞ng",
        cookingMethods: [
          { name: "Cay v·ª´a", price: 55000, description: "ƒê·ªô cay v·ª´a ph·∫£i" },
          { name: "Cay nhi·ªÅu", price: 55000, description: "Cay ƒë·∫≠m ƒë√†" },
          {
            name: "Kh√¥ng cay",
            price: 55000,
            description: "D√†nh cho ng∆∞·ªùi kh√¥ng ƒÉn cay",
          },
        ],
        hasWeight: false,
      },
      {
        id: 3,
        name: "C∆°m G√† X·ªëi M·ª°",
        price: 45000,
        category: "main",
        description: "C∆°m g√† H·∫£i Nam truy·ªÅn th·ªëng",
        cookingMethods: [
          {
            name: "G√† lu·ªôc",
            price: 45000,
            description: "G√† lu·ªôc truy·ªÅn th·ªëng",
          },
          { name: "G√† n∆∞·ªõng", price: 50000, description: "G√† n∆∞·ªõng th∆°m l·ª´ng" },
          { name: "G√† chi√™n", price: 48000, description: "G√† chi√™n gi√≤n r·ª•m" },
        ],
        hasWeight: false,
      },
      {
        id: 4,
        name: "B√≤ Wagyu N∆∞·ªõng",
        price: 500000,
        category: "main",
        description: "Th·ªãt b√≤ Wagyu cao c·∫•p n∆∞·ªõng than hoa",
        cookingMethods: [
          { name: "Rare", price: 500000, description: "T√°i g·∫ßn nh∆∞ s·ªëng" },
          { name: "Medium Rare", price: 500000, description: "T√°i v·ª´a" },
          { name: "Medium", price: 500000, description: "Ch√≠n v·ª´a" },
          { name: "Well Done", price: 500000, description: "Ch√≠n k·ªπ" },
        ],
        hasWeight: true,
        unit: "g",
        baseWeight: 200,
        pricePerGram: 2500,
      },
      {
        id: 5,
        name: "T√¥m H√πm N∆∞·ªõng",
        price: 800000,
        category: "main",
        description: "T√¥m h√πm t∆∞∆°i n∆∞·ªõng b∆° t·ªèi",
        cookingMethods: [
          {
            name: "N∆∞·ªõng b∆° t·ªèi",
            price: 800000,
            description: "N∆∞·ªõng v·ªõi b∆° t·ªèi th∆°m",
          },
          {
            name: "N∆∞·ªõng ph√¥ mai",
            price: 850000,
            description: "N∆∞·ªõng v·ªõi ph√¥ mai tan ch·∫£y",
          },
          {
            name: "N∆∞·ªõng mu·ªëi ·ªõt",
            price: 800000,
            description: "N∆∞·ªõng mu·ªëi ·ªõt cay n·ªìng",
          },
        ],
        hasWeight: true,
        unit: "kg",
        baseWeight: 0.5,
        pricePerGram: 1600,
      },
    ],
    beverages: [
      {
        id: 9,
        name: "Tr√† ƒê√°",
        price: 5000,
        category: "beverage",
        description: "Tr√† ƒë√° truy·ªÅn th·ªëng",
        cookingMethods: [
          { name: "ƒê√° nhi·ªÅu", price: 5000, description: "Nhi·ªÅu ƒë√° m√°t l·∫°nh" },
          { name: "ƒê√° √≠t", price: 5000, description: "√çt ƒë√°, ƒë·∫≠m ƒë√†" },
          { name: "Kh√¥ng ƒë√°", price: 5000, description: "Tr√† n√≥ng" },
        ],
        hasWeight: false,
      },
      {
        id: 10,
        name: "N∆∞·ªõc Ng·ªçt",
        price: 15000,
        category: "beverage",
        description: "Coca Cola, Pepsi, Sprite",
        cookingMethods: [
          {
            name: "Coca Cola",
            price: 15000,
            description: "Coca Cola nguy√™n ch·∫•t",
          },
          { name: "Pepsi", price: 15000, description: "Pepsi Cola" },
          { name: "Sprite", price: 15000, description: "Sprite chanh" },
          { name: "7Up", price: 15000, description: "7Up chanh" },
        ],
        hasWeight: false,
      },
      {
        id: 11,
        name: "Bia S√†i G√≤n",
        price: 25000,
        category: "beverage",
        description: "Bia S√†i G√≤n ƒë·ªè, xanh",
        cookingMethods: [
          { name: "Bia ƒë·ªè", price: 25000, description: "Bia S√†i G√≤n ƒë·ªè" },
          { name: "Bia xanh", price: 25000, description: "Bia S√†i G√≤n xanh" },
        ],
        hasWeight: false,
      },
      {
        id: 12,
        name: "R∆∞·ª£u Vang ƒê·ªè",
        price: 350000,
        category: "beverage",
        description: "R∆∞·ª£u vang ƒë·ªè cao c·∫•p",
        cookingMethods: [
          {
            name: "Dalat Wine",
            price: 350000,
            description: "R∆∞·ª£u vang ƒê√† L·∫°t",
          },
          {
            name: "Imported Wine",
            price: 450000,
            description: "R∆∞·ª£u vang nh·∫≠p kh·∫©u",
          },
        ],
        hasWeight: false,
      },
    ],
  });
  // Modal states
  const [showTableDiagram, setShowTableDiagram] = useState(false);
  const [showTableDetail, setShowTableDetail] = useState(false);
  const [showFloorModal, setShowFloorModal] = useState(false);
  const [showAddTableModal, setShowAddTableModal] = useState(false);
  const [showOrderModal, setShowOrderModal] = useState(false);
  const [showPaymentModal, setShowPaymentModal] = useState(false);
  const [showCookingMethodModal, setShowCookingMethodModal] = useState(false);
  // Current selections
  const [currentTable, setCurrentTable] = useState(null);
  const [currentFloor, setCurrentFloor] = useState(1);
  const [selectedTableDetail, setSelectedTableDetail] = useState(null);
  const [currentOrder, setCurrentOrder] = useState({});
  const [selectedDeliveryPartner, setSelectedDeliveryPartner] = useState(null);
  const [selectedPaymentMethod, setSelectedPaymentMethod] = useState("cash");
  const [currentCookingItem, setCurrentCookingItem] = useState(null);
  const [selectedCookingMethod, setSelectedCookingMethod] = useState(null);
  // Search and filter states
  const [searchQuery, setSearchQuery] = useState("");
  const [menuSearchQuery, setMenuSearchQuery] = useState("");
  const [diagramSearchQuery, setDiagramSearchQuery] = useState("");
  const [currentFilters, setCurrentFilters] = useState({
    status: "",
    area: "",
    seats: "",
  });
  const [currentSort, setCurrentSort] = useState("number");
  const [diagramFloorFilter, setDiagramFloorFilter] = useState("");
  const [diagramStatusFilter, setDiagramStatusFilter] = useState("");
  // Form states
  const [floorForm, setFloorForm] = useState({
    name: "",
    icon: "",
    description: "",
  });
  const [tableForm, setTableForm] = useState({
    number: "",
    seats: 4,
    floorId: "",
    area: "indoor",
  });
  const [customerPaid, setCustomerPaid] = useState("");
  const [editingFloor, setEditingFloor] = useState(null);
  // Notification state
  const [notification, setNotification] = useState({
    show: false,
    message: "",
    type: "success",
  });
  // Utility functions
  const formatCurrency = (amount) => {
    return new Intl.NumberFormat("vi-VN", {
      style: "currency",
      currency: "VND",
    }).format(amount);
  };
  const calculateDuration = (startTime) => {
    if (!startTime) return "Ch∆∞a v√†o";
    const now = new Date();
    const start = new Date();
    const [hours, minutes] = startTime.split(":");
    start.setHours(parseInt(hours), parseInt(minutes), 0, 0);
    const diffMs = now - start;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    if (diffMins < 60) {
      return `${diffMins} ph√∫t`;
    } else {
      const hours = Math.floor(diffMins / 60);
      const mins = diffMins % 60;
      return `${hours}h ${mins}p`;
    }
  };
  const getStatusText = (status) => {
    const statusMap = {
      available: "Tr·ªëng",
      occupied: "C√≥ kh√°ch",
      reserved: "ƒê√£ ƒë·∫∑t",
      cleaning: "D·ªçn d·∫πp",
    };
    return statusMap[status] || status;
  };
  const getAreaText = (area) => {
    const areaMap = {
      indoor: "Trong nh√†",
      outdoor: "Ngo√†i tr·ªùi",
      takeaway: "Mang v·ªÅ",
      vip: "VIP",
    };
    return areaMap[area] || area;
  };
  const showNotification = (message, type = "success") => {
    setNotification({ show: true, message, type });
    setTimeout(
      () => setNotification({ show: false, message: "", type: "success" }),
      3000
    );
  };
  // Chart calculation
  const getTableStats = () => {
    const stats = tables.reduce((acc, table) => {
      acc[table.status] = (acc[table.status] || 0) + 1;
      return acc;
    }, {});
    return {
      total: tables.length,
      available: stats.available || 0,
      occupied: stats.occupied || 0,
      reserved: stats.reserved || 0,
      cleaning: stats.cleaning || 0,
    };
  };
  const getFloorTableCount = (floorId) => {
    return tables.filter((table) => table.floorId === floorId).length;
  };
  // Table operations
  const changeTableStatus = (tableId, newStatus) => {
    setTables((prevTables) =>
      prevTables.map((table) => {
        if (table.id === tableId) {
          const updatedTable = { ...table, status: newStatus };
          if (newStatus === "available") {
            updatedTable.customer = null;
            updatedTable.orderTime = null;
            updatedTable.total = 0;
            updatedTable.orders = [];
            updatedTable.entryTime = null;
            updatedTable.guestCount = 0;
          }
          if (newStatus === "occupied" && !table.customer) {
            updatedTable.customer = "Kh√°ch h√†ng m·ªõi";
            updatedTable.orderTime = new Date().toLocaleTimeString("vi-VN", {
              hour: "2-digit",
              minute: "2-digit",
            });
            updatedTable.entryTime = new Date().toLocaleTimeString("vi-VN", {
              hour: "2-digit",
              minute: "2-digit",
            });
            updatedTable.guestCount = Math.min(table.seats, 2);
          }
          return updatedTable;
        }
        return table;
      })
    );
  };
  const handleTableClick = (tableId) => {
    const table = tables.find((t) => t.id === tableId);
    if (table.status === "occupied" || table.status === "reserved") {
      setSelectedTableDetail(table);
      setShowTableDetail(true);
    }
  };
  // Floor operations
  const selectFloor = (floorId) => {
    setFloors((prevFloors) =>
      prevFloors.map((floor) => ({ ...floor, active: floor.id === floorId }))
    );
    setCurrentFloor(floorId);
  };
  const saveFloor = () => {
    if (!floorForm.name.trim()) {
      showNotification("Vui l√≤ng nh·∫≠p t√™n t·∫ßng!", "error");
      return;
    }
    if (editingFloor) {
      setFloors((prevFloors) =>
        prevFloors.map((floor) =>
          floor.id === editingFloor.id
            ? { ...floor, ...floorForm, icon: floorForm.icon || "üè¢" }
            : floor
        )
      );
      showNotification("ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin t·∫ßng!");
    } else {
      const newFloor = {
        id: Math.max(...floors.map((f) => f.id)) + 1,
        ...floorForm,
        icon: floorForm.icon || "üè¢",
        active: false,
      };
      setFloors((prevFloors) => [...prevFloors, newFloor]);
      showNotification("ƒê√£ th√™m t·∫ßng m·ªõi!");
    }
    setShowFloorModal(false);
    setFloorForm({ name: "", icon: "", description: "" });
    setEditingFloor(null);
  };
  const editFloor = (floorId) => {
    const floor = floors.find((f) => f.id === floorId);
    setEditingFloor(floor);
    setFloorForm({
      name: floor.name,
      icon: floor.icon,
      description: floor.description,
    });
    setShowFloorModal(true);
  };
  const deleteFloor = (floorId) => {
    const floor = floors.find((f) => f.id === floorId);
    const tableCount = getFloorTableCount(floorId);
    if (tableCount > 0) {
      showNotification(
        `Kh√¥ng th·ªÉ x√≥a t·∫ßng "${floor.name}" v√¨ c√≤n ${tableCount} b√†n!`,
        "error"
      );
      return;
    }
    if (window.confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫ßng "${floor.name}"?`)) {
      setFloors((prevFloors) => prevFloors.filter((f) => f.id !== floorId));
      if (currentFloor === floorId) {
        setCurrentFloor(null);
      }
      showNotification("ƒê√£ x√≥a t·∫ßng!");
    }
  };
  // Table management
  const saveTable = () => {
    const { number, seats, floorId, area } = tableForm;
    if (!number || !seats || !floorId || !area) {
      showNotification("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!", "error");
      return;
    }
    if (tables.some((t) => t.number.toLowerCase() === number.toLowerCase())) {
      showNotification("S·ªë b√†n ƒë√£ t·ªìn t·∫°i!", "error");
      return;
    }
    const newTable = {
      id: Math.max(...tables.map((t) => t.id)) + 1,
      number,
      seats: parseInt(seats),
      status: "available",
      floorId: parseInt(floorId),
      area,
      customer: null,
      orderTime: null,
      total: 0,
      orders: [],
      entryTime: null,
      guestCount: 0,
      x: Math.random() * 400 + 50,
      y: Math.random() * 300 + 50,
    };
    setTables((prevTables) => [...prevTables, newTable]);
    setShowAddTableModal(false);
    setTableForm({ number: "", seats: 4, floorId: "", area: "indoor" });
    showNotification("ƒê√£ th√™m b√†n m·ªõi!");
  };
  // Order operations
  const openOrderModal = (tableId) => {
    const table = tables.find((t) => t.id === tableId);
    setCurrentTable(table);
    setCurrentOrder({});
    setMenuSearchQuery("");
    setSelectedDeliveryPartner(null);
    setShowOrderModal(true);
  };
  const selectCookingMethod = (itemId, method) => {
    setCurrentOrder((prev) => ({
      ...prev,
      [itemId]: {
        ...prev[itemId],
        cookingMethod: method.name,
        price: method.price,
        quantity: prev[itemId]?.quantity || 0,
      },
    }));
    setShowCookingMethodModal(false);
  };
  const updateQuantity = (itemId, change) => {
    const currentQty = currentOrder[itemId]?.quantity || 0;
    let newQty;
    if (change === 0) {
      newQty = currentQty;
    } else {
      newQty = Math.max(0, currentQty + change);
    }
    if (newQty > 0) {
      if (!currentOrder[itemId] || !currentOrder[itemId].cookingMethod) {
        const item = [...menuItems.main, ...menuItems.beverages].find(
          (i) => i.id == itemId
        );
        setCurrentCookingItem(item);
        setShowCookingMethodModal(true);
        return;
      }
      setCurrentOrder((prev) => ({
        ...prev,
        [itemId]: { ...prev[itemId], quantity: newQty },
      }));
    } else {
      setCurrentOrder((prev) => ({
        ...prev,
        [itemId]: { ...prev[itemId], quantity: 0 },
      }));
    }
  };
  const submitOrder = () => {
    const orderItems = Object.keys(currentOrder).filter(
      (itemId) => currentOrder[itemId].quantity > 0
    );
    if (orderItems.length === 0) {
      showNotification("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt m√≥n!", "error");
      return;
    }
    if (currentTable.area === "takeaway" && !selectedDeliveryPartner) {
      showNotification(
        "Vui l√≤ng ch·ªçn ƒë·ªëi t√°c giao h√†ng cho ƒë∆°n mang v·ªÅ!",
        "error"
      );
      return;
    }
    const newOrders = orderItems.map((itemId) => {
      const item = [...menuItems.main, ...menuItems.beverages].find(
        (i) => i.id == itemId
      );
      const orderItem = currentOrder[itemId];
      const itemPrice = orderItem.price || item.price;
      const subtotal = itemPrice * orderItem.quantity;
      let itemName = item.name;
      if (orderItem.weight && orderItem.weight > 0) {
        itemName += ` (${orderItem.weight}${item.unit || "kg"})`;
      }
      return {
        item: itemName,
        quantity: orderItem.quantity,
        price: itemPrice,
        subtotal: subtotal,
        cookingMethod: orderItem.cookingMethod || "",
        customMethod: orderItem.customMethod || "",
        weight: orderItem.weight || 0,
      };
    });
    setTables((prevTables) =>
      prevTables.map((table) => {
        if (table.id === currentTable.id) {
          const updatedOrders = [...(table.orders || []), ...newOrders];
          return {
            ...table,
            orders: updatedOrders,
            total: updatedOrders.reduce(
              (sum, order) => sum + order.subtotal,
              0
            ),
            status: "occupied",
            customer: table.customer || "Kh√°ch h√†ng m·ªõi",
            orderTime:
              table.orderTime ||
              new Date().toLocaleTimeString("vi-VN", {
                hour: "2-digit",
                minute: "2-digit",
              }),
            entryTime:
              table.entryTime ||
              new Date().toLocaleTimeString("vi-VN", {
                hour: "2-digit",
                minute: "2-digit",
              }),
          };
        }
        return table;
      })
    );
    setShowOrderModal(false);
    showNotification("‚úÖ ƒê√£ th√™m ƒë∆°n h√†ng th√†nh c√¥ng!");
  };
  // Payment operations
  const openPaymentModal = () => {
    if (!selectedTableDetail || selectedTableDetail.total <= 0) {
      showNotification("B√†n n√†y ch∆∞a c√≥ ƒë∆°n h√†ng ƒë·ªÉ thanh to√°n!", "error");
      return;
    }
    setShowPaymentModal(true);
  };
  const calculateChange = () => {
    const paid = parseFloat(customerPaid) || 0;
    const subtotal = selectedTableDetail?.total || 0;
    const tax = Math.round(subtotal * 0.1);
    const total = subtotal + tax;
    return paid - total;
  };
  const processPaymentConfirm = () => {
    const subtotal = selectedTableDetail.total;
    const tax = Math.round(subtotal * 0.1);
    const total = subtotal + tax;
    if (selectedPaymentMethod === "cash") {
      const paid = parseFloat(customerPaid) || 0;
      if (paid < total) {
        showNotification("S·ªë ti·ªÅn kh√°ch ƒë∆∞a kh√¥ng ƒë·ªß!", "error");
        return;
      }
    }
    if (
      window.confirm("Thanh to√°n th√†nh c√¥ng! B·∫°n c√≥ mu·ªën in h√≥a ƒë∆°n kh√¥ng?")
    ) {
      printInvoice();
    }
    changeTableStatus(selectedTableDetail.id, "cleaning");
    setShowPaymentModal(false);
    setShowTableDetail(false);
    setCustomerPaid("");
    const paymentMethodText = {
      cash: "ti·ªÅn m·∫∑t",
      card: "th·∫ª ng√¢n h√†ng",
      transfer: "chuy·ªÉn kho·∫£n",
    };
    showNotification(
      `‚úÖ Thanh to√°n th√†nh c√¥ng b·∫±ng ${paymentMethodText[selectedPaymentMethod]}!`
    );
  };
  const printInvoice = () => {
    console.log("Printing invoice for table:", selectedTableDetail.number);
    showNotification("üñ®Ô∏è ƒê√£ g·ª≠i l·ªánh in h√≥a ƒë∆°n!");
  };
  // Filter and search functions
  const getFilteredTables = () => {
    let filteredTables = [...tables];
    if (currentFloor) {
      filteredTables = filteredTables.filter(
        (table) => table.floorId === currentFloor
      );
    }
    if (searchQuery) {
      filteredTables = filteredTables.filter(
        (table) =>
          table.number.toLowerCase().includes(searchQuery.toLowerCase()) ||
          (table.customer &&
            table.customer.toLowerCase().includes(searchQuery.toLowerCase()))
      );
    }
    if (currentFilters.status) {
      filteredTables = filteredTables.filter(
        (table) => table.status === currentFilters.status
      );
    }
    if (currentFilters.area) {
      filteredTables = filteredTables.filter(
        (table) => table.area === currentFilters.area
      );
    }
    filteredTables.sort((a, b) => {
      switch (currentSort) {
        case "number":
          return a.number.localeCompare(b.number);
        case "status":
          const statusOrder = {
            occupied: 0,
            reserved: 1,
            cleaning: 2,
            available: 3,
          };
          return (statusOrder[a.status] || 4) - (statusOrder[b.status] || 4);
        case "total-desc":
          return b.total - a.total;
        default:
          return 0;
      }
    });
    return filteredTables;
  };
  const getFilteredMenuItems = () => {
    const allItems = [...menuItems.main, ...menuItems.beverages];
    if (!menuSearchQuery) return allItems;
    return allItems.filter(
      (item) =>
        item.name.toLowerCase().includes(menuSearchQuery.toLowerCase()) ||
        item.description.toLowerCase().includes(menuSearchQuery.toLowerCase())
    );
  };
  const getDiagramFilteredTables = () => {
    let filteredTables = [...tables];
    if (diagramFloorFilter) {
      filteredTables = filteredTables.filter(
        (table) => table.floorId === parseInt(diagramFloorFilter)
      );
    }
    if (diagramStatusFilter) {
      filteredTables = filteredTables.filter(
        (table) => table.status === diagramStatusFilter
      );
    }
    if (diagramSearchQuery) {
      filteredTables = filteredTables.filter(
        (table) =>
          table.number
            .toLowerCase()
            .includes(diagramSearchQuery.toLowerCase()) ||
          (table.customer &&
            table.customer
              .toLowerCase()
              .includes(diagramSearchQuery.toLowerCase()))
      );
    }
    return filteredTables;
  };
  // Render functions
  const renderCircularChart = () => {
    const stats = getTableStats();
    const { total, available, occupied, reserved, cleaning } = stats;
    if (total === 0) {
      return (
        <div className="chart-container">
          <div className="chart-wrapper">
            <div className="chart-center">
              <div className="chart-total">0</div>
              <div className="chart-label">Ch∆∞a c√≥ b√†n</div>
            </div>
          </div>
        </div>
      );
    }
    const radius = 55;
    const circumference = 2 * Math.PI * radius;
    const availablePercent = (available / total) * 100;
    const occupiedPercent = (occupied / total) * 100;
    const reservedPercent = (reserved / total) * 100;
    const cleaningPercent = (cleaning / total) * 100;
    let currentOffset = 0;
    const availableOffset = currentOffset;
    currentOffset += (availablePercent / 100) * circumference;
    const occupiedOffset = currentOffset;
    currentOffset += (occupiedPercent / 100) * circumference;
    const reservedOffset = currentOffset;
    currentOffset += (reservedPercent / 100) * circumference;
    const cleaningOffset = currentOffset;
    return (
      <div className="chart-container">
        <div className="chart-wrapper">
          <svg className="chart-svg" width="140" height="140">
            <circle
              cx="70"
              cy="70"
              r={radius}
              fill="none"
              stroke="#e2e8f0"
              strokeWidth="16"
            />
            {available > 0 && (
              <circle
                cx="70"
                cy="70"
                r={radius}
                fill="none"
                stroke="#10b981"
                strokeWidth="16"
                strokeDasharray={`${
                  (availablePercent / 100) * circumference
                } ${circumference}`}
                strokeDashoffset={-availableOffset}
                transform="rotate(-90 70 70)"
              />
            )}
            {occupied > 0 && (
              <circle
                cx="70"
                cy="70"
                r={radius}
                fill="none"
                stroke="#f59e0b"
                strokeWidth="16"
                strokeDasharray={`${
                  (occupiedPercent / 100) * circumference
                } ${circumference}`}
                strokeDashoffset={-occupiedOffset}
                transform="rotate(-90 70 70)"
              />
            )}
            {reserved > 0 && (
              <circle
                cx="70"
                cy="70"
                r={radius}
                fill="none"
                stroke="#3b82f6"
                strokeWidth="16"
                strokeDasharray={`${
                  (reservedPercent / 100) * circumference
                } ${circumference}`}
                strokeDashoffset={-reservedOffset}
                transform="rotate(-90 70 70)"
              />
            )}
            {cleaning > 0 && (
              <circle
                cx="70"
                cy="70"
                r={radius}
                fill="none"
                stroke="#8b5cf6"
                strokeWidth="16"
                strokeDasharray={`${
                  (cleaningPercent / 100) * circumference
                } ${circumference}`}
                strokeDashoffset={-cleaningOffset}
                transform="rotate(-90 70 70)"
              />
            )}
          </svg>
          <div className="chart-center">
            <div className="chart-total">{total}</div>
            <div className="chart-label">T·ªïng b√†n</div>
          </div>
        </div>
        <div className="chart-legend">
          <div className="legend-item">
            <div className="legend-color available"></div>
            <span>Tr·ªëng ({available})</span>
          </div>
          <div className="legend-item">
            <div className="legend-color occupied"></div>
            <span>C√≥ kh√°ch ({occupied})</span>
          </div>
          <div className="legend-item">
            <div className="legend-color reserved"></div>
            <span>ƒê√£ ƒë·∫∑t ({reserved})</span>
          </div>
          <div className="legend-item">
            <div className="legend-color cleaning"></div>
            <span>D·ªçn d·∫πp ({cleaning})</span>
          </div>
        </div>
      </div>
    );
  };
  const renderTableActions = (table) => {
    switch (table.status) {
      case "available":
        return (
          <div className="table-actions">
            <Button
              size="sm"
              variant="success"
              onClick={(e) => {
                e.stopPropagation();
                changeTableStatus(table.id, "occupied");
              }}
            >
              üçΩÔ∏è Nh·∫≠n
            </Button>
            <Button
              size="sm"
              variant="info"
              onClick={(e) => {
                e.stopPropagation();
                changeTableStatus(table.id, "reserved");
              }}
            >
              üìÖ ƒê·∫∑t
            </Button>
          </div>
        );
      case "occupied":
        return (
          <div className="table-actions">
            <Button
              size="sm"
              variant="warning"
              onClick={(e) => {
                e.stopPropagation();
                openOrderModal(table.id);
              }}
            >
              üìù Order
            </Button>
            <Button
              size="sm"
              variant="success"
              onClick={(e) => {
                e.stopPropagation();
                setSelectedTableDetail(table);
                setShowPaymentModal(true);
              }}
            >
              üí∞ TT
            </Button>
          </div>
        );
      case "reserved":
        return (
          <div className="table-actions">
            <Button
              size="sm"
              variant="success"
              onClick={(e) => {
                e.stopPropagation();
                changeTableStatus(table.id, "occupied");
              }}
            >
              ‚úÖ ƒê·∫øn
            </Button>
            <Button
              size="sm"
              variant="secondary"
              onClick={(e) => {
                e.stopPropagation();
                changeTableStatus(table.id, "available");
              }}
            >
              ‚ùå H·ªßy
            </Button>
          </div>
        );
      case "cleaning":
        return (
          <div className="table-actions">
            <Button
              size="sm"
              variant="primary"
              onClick={(e) => {
                e.stopPropagation();
                changeTableStatus(table.id, "available");
              }}
            >
              ‚ú® Xong
            </Button>
          </div>
        );
      default:
        return null;
    }
  };
  return (
    <div className="table-management">
      {/* Notification */}
      {notification.show && (
        <Notification
          message={notification.message}
          type={notification.type}
          onClose={() =>
            setNotification({ show: false, message: "", type: "success" })
          }
        />
      )}
      {/* Top Actions Bar */}
      <div className="top-actions">
        <h1>üçΩÔ∏è Qu·∫£n L√Ω B√†n ƒÇn</h1>
        <div className="top-actions-right">
          <Button
            variant="secondary"
            size="sm"
            onClick={() => setShowTableDiagram(true)}
          >
            üó∫Ô∏è S∆° ƒë·ªì b√†n
          </Button>
          <Button
            variant="secondary"
            size="sm"
            onClick={() => setShowFloorModal(true)}
          >
            üèóÔ∏è Th√™m t·∫ßng
          </Button>
        </div>
      </div>
      {/* Main Layout */}
      <div className="main-layout">
        {/* table_sidebar */}
        <aside className="table_sidebar">
          {/* Circular Chart */}
          <div className="table_sidebar-section">{renderCircularChart()}</div>
          {/* Search Tables */}
          <div className="table_sidebar-section">
            <h3 className="table_sidebar-title">üîç T√¨m b√†n</h3>
            <div className="search-container">
              <input
                type="text"
                className="search-input"
                placeholder="T√¨m b√†n theo s·ªë, kh√°ch..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
              />
              <span className="search-icon">üîç</span>
            </div>
          </div>
          {/* Floor Management */}
          <div className="table_sidebar-section">
            <h3 className="table_sidebar-title">üè¢ T·∫ßng</h3>
            <div className="floor-list">
              {floors.map((floor) => (
                <div
                  key={floor.id}
                  className={`floor-item ${floor.active ? "active" : ""}`}
                  onClick={() => selectFloor(floor.id)}
                >
                  <div className="floor-info">
                    <span>{floor.icon}</span>
                    <div>
                      <div className="floor-name">{floor.name}</div>
                      <div className="floor-count">
                        {getFloorTableCount(floor.id)} b√†n
                      </div>
                    </div>
                  </div>
                  <div className="floor-actions">
                    <button
                      className="floor-btn edit"
                      onClick={(e) => {
                        e.stopPropagation();
                        editFloor(floor.id);
                      }}
                      title="S·ª≠a"
                    >
                      ‚úèÔ∏è
                    </button>
                    <button
                      className="floor-btn delete"
                      onClick={(e) => {
                        e.stopPropagation();
                        deleteFloor(floor.id);
                      }}
                      title="X√≥a"
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </aside>
        {/* Main Content */}
        <main className="main-content">
          <div className="tables-container">
            <div className="tables-header">
              <h2>
                {currentFloor
                  ? `${floors.find((f) => f.id === currentFloor)?.icon} ${
                      floors.find((f) => f.id === currentFloor)?.name
                    }`
                  : "üìç T·∫•t c·∫£ b√†n"}
              </h2>
              <div className="header-actions">
                <Button
                  variant="primary"
                  size="sm"
                  onClick={() => setShowAddTableModal(true)}
                >
                  ‚ûï Th√™m b√†n
                </Button>
                <Button
                  variant="secondary"
                  size="sm"
                  onClick={() =>
                    showNotification("üîÑ ƒê√£ l√†m m·ªõi danh s√°ch b√†n!")
                  }
                >
                  üîÑ L√†m m·ªõi
                </Button>
              </div>
            </div>
            {/* Table Controls */}
            <div className="table-controls">
              <div className="filter-section">
                <select
                  className="filter-select"
                  value={currentFilters.status}
                  onChange={(e) =>
                    setCurrentFilters((prev) => ({
                      ...prev,
                      status: e.target.value,
                    }))
                  }
                >
                  <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                  <option value="available">üü¢ Tr·ªëng</option>
                  <option value="occupied">üü° C√≥ kh√°ch</option>
                  <option value="reserved">üîµ ƒê√£ ƒë·∫∑t</option>
                  <option value="cleaning">üü£ D·ªçn d·∫πp</option>
                </select>
                <select
                  className="filter-select"
                  value={currentFilters.area}
                  onChange={(e) =>
                    setCurrentFilters((prev) => ({
                      ...prev,
                      area: e.target.value,
                    }))
                  }
                >
                  <option value="">T·∫•t c·∫£ khu v·ª±c</option>
                  <option value="indoor">üè¢ Trong nh√†</option>
                  <option value="outdoor">üå≥ Ngo√†i tr·ªùi</option>
                  <option value="vip">üëë VIP</option>
                  <option value="takeaway">üì¶ Mang v·ªÅ</option>
                </select>
                <select
                  className="filter-select"
                  value={currentSort}
                  onChange={(e) => setCurrentSort(e.target.value)}
                >
                  <option value="number">S·ªë b√†n A-Z</option>
                  <option value="status">Theo tr·∫°ng th√°i</option>
                  <option value="total-desc">Doanh thu cao</option>
                </select>
                <Button
                  variant="secondary"
                  size="sm"
                  onClick={() => {
                    setCurrentFilters({ status: "", area: "", seats: "" });
                    setCurrentSort("number");
                  }}
                >
                  üóëÔ∏è X√≥a l·ªçc
                </Button>
              </div>
            </div>
            {/* Tables Grid */}
            <div className="tables-grid">
              {getFilteredTables().length === 0 ? (
                <div className="empty-state">
                  <div className="empty-state-icon">üçΩÔ∏è</div>
                  <div className="empty-state-text">Kh√¥ng t√¨m th·∫•y b√†n n√†o</div>
                  <div className="empty-state-subtext">
                    Th·ª≠ thay ƒë·ªïi b·ªô l·ªçc ho·∫∑c th√™m b√†n m·ªõi
                  </div>
                </div>
              ) : (
                getFilteredTables().map((table) => (
                  <Card
                    key={table.id}
                    className={`table-card ${table.status}`}
                    onClick={() => handleTableClick(table.id)}
                  >
                    <div className="table-header">
                      <div className="table-number">{table.number}</div>
                      <div className={`table-status status-${table.status}`}>
                        {getStatusText(table.status)}
                      </div>
                    </div>
                    <div className="table-info">
                      <div className="table-detail">
                        <span>üë•</span>
                        <span>
                          {table.seats > 0 ? table.seats + " ch·ªó" : "Mang v·ªÅ"}
                        </span>
                      </div>
                      <div className="table-detail">
                        <span>üìç</span>
                        <span>{getAreaText(table.area)}</span>
                      </div>
                      {table.customer && (
                        <div className="table-detail">
                          <span>üë§</span>
                          <span>{table.customer}</span>
                        </div>
                      )}
                      {table.orderTime && (
                        <div className="table-detail">
                          <span>‚è∞</span>
                          <span>{table.orderTime}</span>
                        </div>
                      )}
                      {table.total > 0 && (
                        <div className="table-detail">
                          <span>üí∞</span>
                          <span>{formatCurrency(table.total)}</span>
                        </div>
                      )}
                    </div>
                    {renderTableActions(table)}
                  </Card>
                ))
              )}
            </div>
          </div>
        </main>
      </div>
      {/* Table Diagram Modal */}
      <Modal
        isOpen={showTableDiagram}
        onClose={() => setShowTableDiagram(false)}
        title="üó∫Ô∏è S∆° ƒë·ªì b√†n ƒÉn"
        size="large"
      >
        <div className="diagram-controls">
          <div className="diagram-search">
            <input
              type="text"
              className="diagram-search-input"
              placeholder="üîç T√¨m b√†n..."
              value={diagramSearchQuery}
              onChange={(e) => setDiagramSearchQuery(e.target.value)}
            />
          </div>
          <div className="diagram-filters">
            <select
              className="diagram-filter-select"
              value={diagramFloorFilter}
              onChange={(e) => setDiagramFloorFilter(e.target.value)}
            >
              <option value="">T·∫•t c·∫£ t·∫ßng</option>
              {floors.map((floor) => (
                <option key={floor.id} value={floor.id}>
                  {floor.icon} {floor.name}
                </option>
              ))}
            </select>
            <select
              className="diagram-filter-select"
              value={diagramStatusFilter}
              onChange={(e) => setDiagramStatusFilter(e.target.value)}
            >
              <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
              <option value="available">üü¢ Tr·ªëng</option>
              <option value="occupied">üü° C√≥ kh√°ch</option>
              <option value="reserved">üîµ ƒê√£ ƒë·∫∑t</option>
              <option value="cleaning">üü£ D·ªçn d·∫πp</option>
            </select>
          </div>
        </div>
        <div className="diagram-container">
          <svg
            className="diagram-svg"
            width="100%"
            height="500"
            viewBox="0 0 600 400"
          >
            {/* Background grid */}
            <defs>
              <pattern
                id="grid"
                width="20"
                height="20"
                patternUnits="userSpaceOnUse"
              >
                <path
                  d="M 20 0 L 0 0 L 0 20"
                  fill="none"
                  stroke="#f1f5f9"
                  strokeWidth="1"
                />
              </pattern>
            </defs>
            <rect width="100%" height="100%" fill="url(#grid)" />
            {/* Tables */}
            {getDiagramFilteredTables().map((table) => (
              <g key={table.id} className={`diagram-table ${table.status}`}>
                <circle
                  cx={table.x}
                  cy={table.y}
                  r="25"
                  className={`table-circle status-${table.status}`}
                  onClick={() => handleTableClick(table.id)}
                />
                <text
                  x={table.x}
                  y={table.y - 5}
                  textAnchor="middle"
                  className="table-number-text"
                  fontSize="10"
                  fontWeight="bold"
                >
                  {table.number}
                </text>
                <text
                  x={table.x}
                  y={table.y + 8}
                  textAnchor="middle"
                  className="table-seats-text"
                  fontSize="8"
                >
                  {table.seats > 0 ? `${table.seats} ch·ªó` : "Mang v·ªÅ"}
                </text>
                {table.customer && (
                  <text
                    x={table.x}
                    y={table.y + 45}
                    textAnchor="middle"
                    className="table-customer-text"
                    fontSize="8"
                    fill="#64748b"
                  >
                    {table.customer.length > 10
                      ? table.customer.substring(0, 10) + "..."
                      : table.customer}
                  </text>
                )}
              </g>
            ))}
          </svg>
        </div>
        <div className="diagram-legend">
          <div className="legend-item">
            <div className="legend-circle available"></div>
            <span>Tr·ªëng</span>
          </div>
          <div className="legend-item">
            <div className="legend-circle occupied"></div>
            <span>C√≥ kh√°ch</span>
          </div>
          <div className="legend-item">
            <div className="legend-circle reserved"></div>
            <span>ƒê√£ ƒë·∫∑t</span>
          </div>
          <div className="legend-item">
            <div className="legend-circle cleaning"></div>
            <span>D·ªçn d·∫πp</span>
          </div>
        </div>
      </Modal>
      {/* Floor Modal */}
      <Modal
        isOpen={showFloorModal}
        onClose={() => {
          setShowFloorModal(false);
          setFloorForm({ name: "", icon: "", description: "" });
          setEditingFloor(null);
        }}
        title={editingFloor ? "‚úèÔ∏è S·ª≠a th√¥ng tin t·∫ßng" : "üèóÔ∏è Th√™m t·∫ßng m·ªõi"}
      >
        <div className="form-group">
          <label className="form-label">T√™n t·∫ßng</label>
          <input
            type="text"
            className="form-input"
            placeholder="VD: T·∫ßng 1, T·∫ßng tr·ªát, S√¢n th∆∞·ª£ng..."
            value={floorForm.name}
            onChange={(e) =>
              setFloorForm((prev) => ({ ...prev, name: e.target.value }))
            }
          />
        </div>
        <div className="form-group">
          <label className="form-label">Bi·ªÉu t∆∞·ª£ng</label>
          <input
            type="text"
            className="form-input"
            placeholder="VD: 1Ô∏è‚É£, üè¢, üå≥..."
            maxLength="2"
            value={floorForm.icon}
            onChange={(e) =>
              setFloorForm((prev) => ({ ...prev, icon: e.target.value }))
            }
          />
        </div>
        <div className="form-group">
          <label className="form-label">M√¥ t·∫£</label>
          <input
            type="text"
            className="form-input"
            placeholder="M√¥ t·∫£ ng·∫Øn v·ªÅ t·∫ßng n√†y..."
            value={floorForm.description}
            onChange={(e) =>
              setFloorForm((prev) => ({ ...prev, description: e.target.value }))
            }
          />
        </div>
        <div className="modal-footer">
          <Button
            variant="secondary"
            onClick={() => {
              setShowFloorModal(false);
              setFloorForm({ name: "", icon: "", description: "" });
              setEditingFloor(null);
            }}
          >
            H·ªßy
          </Button>
          <Button variant="primary" onClick={saveFloor}>
            üíæ L∆∞u t·∫ßng
          </Button>
        </div>
      </Modal>
      {/* Add Table Modal */}
      <Modal
        isOpen={showAddTableModal}
        onClose={() => {
          setShowAddTableModal(false);
          setTableForm({ number: "", seats: 4, floorId: "", area: "indoor" });
        }}
        title="‚ûï Th√™m b√†n m·ªõi"
      >
        <div className="form-group">
          <label className="form-label">S·ªë b√†n</label>
          <input
            type="text"
            className="form-input"
            placeholder="VD: B01, A12..."
            value={tableForm.number}
            onChange={(e) =>
              setTableForm((prev) => ({ ...prev, number: e.target.value }))
            }
          />
        </div>
        <div className="form-group">
          <label className="form-label">S·ªë ch·ªó ng·ªìi</label>
          <input
            type="number"
            className="form-input"
            min="1"
            max="20"
            value={tableForm.seats}
            onChange={(e) =>
              setTableForm((prev) => ({ ...prev, seats: e.target.value }))
            }
          />
        </div>
        <div className="form-group">
          <label className="form-label">T·∫ßng</label>
          <select
            className="form-select"
            value={tableForm.floorId}
            onChange={(e) =>
              setTableForm((prev) => ({ ...prev, floorId: e.target.value }))
            }
          >
            <option value="">Ch·ªçn t·∫ßng...</option>
            {floors.map((floor) => (
              <option key={floor.id} value={floor.id}>
                {floor.icon} {floor.name}
              </option>
            ))}
          </select>
        </div>
        <div className="form-group">
          <label className="form-label">Khu v·ª±c</label>
          <select
            className="form-select"
            value={tableForm.area}
            onChange={(e) =>
              setTableForm((prev) => ({ ...prev, area: e.target.value }))
            }
          >
            <option value="indoor">üè¢ Trong nh√†</option>
            <option value="outdoor">üå≥ Ngo√†i tr·ªùi</option>
            <option value="takeaway">üì¶ Mang v·ªÅ</option>
            <option value="vip">üëë VIP</option>
          </select>
        </div>
        <div className="modal-footer">
          <Button
            variant="secondary"
            onClick={() => {
              setShowAddTableModal(false);
              setTableForm({
                number: "",
                seats: 4,
                floorId: "",
                area: "indoor",
              });
            }}
          >
            H·ªßy
          </Button>
          <Button variant="primary" onClick={saveTable}>
            üíæ Th√™m b√†n
          </Button>
        </div>
      </Modal>
      {/* Table Detail Modal */}
      <Modal
        isOpen={showTableDetail}
        onClose={() => setShowTableDetail(false)}
        title={selectedTableDetail ? `üçΩÔ∏è ${selectedTableDetail.number}` : ""}
        size="large"
      >
        {selectedTableDetail && (
          <>
            <div className="table-quick-info">
              <span className="quick-info-item">
                üë§ {selectedTableDetail.customer || "Ch∆∞a c√≥ kh√°ch"}
              </span>
              <span className="quick-info-item">
                ‚è∞ {calculateDuration(selectedTableDetail.entryTime)}
              </span>
              <span className="quick-info-item">
                üí∞ {formatCurrency(selectedTableDetail.total)}
              </span>
            </div>
            <div className="orders-section">
              <div className="orders-header">
                <h4 className="section-title">üìã M√≥n ƒë√£ order</h4>
                <div className="orders-summary">
                  <span className="orders-count">
                    {selectedTableDetail.orders?.length || 0} m√≥n
                  </span>
                  <span className="orders-total">
                    {formatCurrency(selectedTableDetail.total)}
                  </span>
                </div>
              </div>
              <div className="orders-list">
                {selectedTableDetail.orders &&
                selectedTableDetail.orders.length > 0 ? (
                  selectedTableDetail.orders.map((order, index) => (
                    <div key={index} className="order-item">
                      <div className="order-item-info">
                        <div className="order-item-name">
                          {order.item}{" "}
                          <span style={{ color: "#64748b" }}>
                            x{order.quantity}
                          </span>
                        </div>
                        <div className="order-item-details">
                          {order.cookingMethod
                            ? `üç≥ ${order.cookingMethod}`
                            : ""}
                          {order.customMethod
                            ? ` ‚Ä¢ ‚ú® ${order.customMethod}`
                            : ""}
                          {!order.cookingMethod && !order.customMethod
                            ? "üìù Kh√¥ng c√≥ ghi ch√∫ ƒë·∫∑c bi·ªát"
                            : ""}
                        </div>
                      </div>
                      <div className="order-item-price">
                        {formatCurrency(order.subtotal)}
                      </div>
                    </div>
                  ))
                ) : (
                  <div className="empty-state">
                    <div className="empty-state-icon">üçΩÔ∏è</div>
                    <div className="empty-state-text">Ch∆∞a c√≥ m√≥n n√†o</div>
                    <div className="empty-state-subtext">
                      Nh·∫•n "Order th√™m" ƒë·ªÉ th√™m m√≥n
                    </div>
                  </div>
                )}
              </div>
            </div>
            <div className="modal-footer">
              <Button
                variant="secondary"
                onClick={() => setShowTableDetail(false)}
              >
                ƒê√≥ng
              </Button>
              {selectedTableDetail.status === "occupied" && (
                <>
                  <Button
                    variant="warning"
                    onClick={() => {
                      setShowTableDetail(false);
                      openOrderModal(selectedTableDetail.id);
                    }}
                  >
                    üìù Order th√™m
                  </Button>
                  <Button variant="success" onClick={openPaymentModal}>
                    üí∞ Thanh to√°n
                  </Button>
                </>
              )}
            </div>
          </>
        )}
      </Modal>
      {/* Order Modal */}
      <Modal
        isOpen={showOrderModal}
        onClose={() => setShowOrderModal(false)}
        title={currentTable ? `üçΩÔ∏è Order cho ${currentTable.number}` : ""}
        size="lg"
      >
        {currentTable && (
          <>
            <div className="order-header">
              <div className="menu-search">
                <input
                  type="text"
                  className="menu-search-input"
                  placeholder="üîç T√¨m m√≥n ƒÉn..."
                  value={menuSearchQuery}
                  onChange={(e) => setMenuSearchQuery(e.target.value)}
                />
              </div>
              {currentTable.area === "takeaway" && (
                <div className="delivery-partners">
                  <h4 className="section-title">üöö Ch·ªçn ƒë·ªëi t√°c giao h√†ng</h4>
                  <div className="partners-grid">
                    {deliveryPartners
                      .filter((partner) => partner.status === "online")
                      .map((partner) => (
                        <div
                          key={partner.id}
                          className={`partner-card ${
                            selectedDeliveryPartner?.id === partner.id
                              ? "selected"
                              : ""
                          }`}
                          onClick={() => setSelectedDeliveryPartner(partner)}
                        >
                          <div className="partner-logo">{partner.logo}</div>
                          <div className="partner-info">
                            <div className="partner-name">{partner.name}</div>
                            <div className="partner-commission">
                              Hoa h·ªìng: {partner.commission}
                            </div>
                            <div className="partner-rating">
                              ‚≠ê {partner.rating}
                            </div>
                          </div>
                        </div>
                      ))}
                  </div>
                </div>
              )}
            </div>
            <div className="menu-sections">
              <div className="menu-section">
                <h4 className="section-title">üçú M√≥n ch√≠nh</h4>
                <div className="menu-items">
                  {getFilteredMenuItems()
                    .filter((item) => item.category === "main")
                    .map((item) => (
                      <div key={item.id} className="menu-item">
                        <div className="menu-item-info">
                          <div className="menu-item-name">{item.name}</div>
                          <div className="menu-item-description">
                            {item.description}
                          </div>
                          <div className="menu-item-price">
                            {formatCurrency(item.price)}
                          </div>
                          {currentOrder[item.id]?.cookingMethod && (
                            <div className="selected-method">
                              üç≥ {currentOrder[item.id].cookingMethod}
                            </div>
                          )}
                        </div>
                        <div className="menu-item-actions">
                          <div className="quantity-controls">
                            <Button
                              size="sm"
                              variant="secondary"
                              onClick={() => updateQuantity(item.id, -1)}
                              disabled={
                                !currentOrder[item.id] ||
                                currentOrder[item.id].quantity <= 0
                              }
                            >
                              -
                            </Button>
                            <span className="quantity">
                              {currentOrder[item.id]?.quantity || 0}
                            </span>
                            <Button
                              size="sm"
                              variant="secondary"
                              onClick={() => updateQuantity(item.id, 1)}
                            >
                              +
                            </Button>
                          </div>
                        </div>
                      </div>
                    ))}
                </div>
              </div>
              <div className="menu-section">
                <h4 className="section-title">ü•§ ƒê·ªì u·ªëng</h4>
                <div className="menu-items">
                  {getFilteredMenuItems()
                    .filter((item) => item.category === "beverage")
                    .map((item) => (
                      <div key={item.id} className="menu-item">
                        <div className="menu-item-info">
                          <div className="menu-item-name">{item.name}</div>
                          <div className="menu-item-description">
                            {item.description}
                          </div>
                          <div className="menu-item-price">
                            {formatCurrency(item.price)}
                          </div>
                          {currentOrder[item.id]?.cookingMethod && (
                            <div className="selected-method">
                              üç≥ {currentOrder[item.id].cookingMethod}
                            </div>
                          )}
                        </div>
                        <div className="menu-item-actions">
                          <div className="quantity-controls">
                            <Button
                              size="sm"
                              variant="secondary"
                              onClick={() => updateQuantity(item.id, -1)}
                              disabled={
                                !currentOrder[item.id] ||
                                currentOrder[item.id].quantity <= 0
                              }
                            >
                              -
                            </Button>
                            <span className="quantity">
                              {currentOrder[item.id]?.quantity || 0}
                            </span>
                            <Button
                              size="sm"
                              variant="secondary"
                              onClick={() => updateQuantity(item.id, 1)}
                            >
                              +
                            </Button>
                          </div>
                        </div>
                      </div>
                    ))}
                </div>
              </div>
            </div>
            <div className="order-summary">
              <h4 className="section-title">üìã T√≥m t·∫Øt ƒë∆°n h√†ng</h4>
              <div className="summary-items">
                {Object.keys(currentOrder).filter(
                  (itemId) => currentOrder[itemId].quantity > 0
                ).length === 0 ? (
                  <div className="summary-item">
                    <span>Ch∆∞a c√≥ m√≥n n√†o</span>
                    <span>0ƒë</span>
                  </div>
                ) : (
                  Object.keys(currentOrder)
                    .filter((itemId) => currentOrder[itemId].quantity > 0)
                    .map((itemId) => {
                      const item = [
                        ...menuItems.main,
                        ...menuItems.beverages,
                      ].find((i) => i.id == itemId);
                      const orderItem = currentOrder[itemId];
                      const itemPrice = orderItem.price || item.price;
                      const subtotal = itemPrice * orderItem.quantity;
                      return (
                        <div key={itemId} className="summary-item">
                          <span>
                            {item.name} x{orderItem.quantity}
                          </span>
                          <span>{formatCurrency(subtotal)}</span>
                        </div>
                      );
                    })
                )}
                <div className="summary-total">
                  <span>T·ªïng c·ªông:</span>
                  <span>
                    {formatCurrency(
                      Object.keys(currentOrder)
                        .filter((itemId) => currentOrder[itemId].quantity > 0)
                        .reduce((total, itemId) => {
                          const item = [
                            ...menuItems.main,
                            ...menuItems.beverages,
                          ].find((i) => i.id == itemId);
                          const orderItem = currentOrder[itemId];
                          const itemPrice = orderItem.price || item.price;
                          return total + itemPrice * orderItem.quantity;
                        }, 0)
                    )}
                  </span>
                </div>
              </div>
            </div>
            <div className="modal-footer">
              <Button
                variant="secondary"
                onClick={() => setShowOrderModal(false)}
              >
                H·ªßy
              </Button>
              <Button variant="primary" onClick={submitOrder}>
                üõí X√°c nh·∫≠n ƒë∆°n h√†ng
              </Button>
            </div>
          </>
        )}
      </Modal>
      {/* Cooking Method Modal */}
      <Modal
        isOpen={showCookingMethodModal}
        onClose={() => setShowCookingMethodModal(false)}
        title={
          currentCookingItem
            ? `üç≥ Ch·ªçn c√°ch ch·∫ø bi·∫øn - ${currentCookingItem.name}`
            : ""
        }
      >
        {currentCookingItem && (
          <>
            <div className="cooking-methods">
              {currentCookingItem.cookingMethods.map((method, index) => (
                <div
                  key={index}
                  className="cooking-method"
                  onClick={() =>
                    selectCookingMethod(currentCookingItem.id, method)
                  }
                >
                  <div className="method-info">
                    <div className="method-name">{method.name}</div>
                    <div className="method-description">
                      {method.description}
                    </div>
                  </div>
                  <div className="method-price">
                    {formatCurrency(method.price)}
                  </div>
                </div>
              ))}
            </div>
            <div className="modal-footer">
              <Button
                variant="secondary"
                onClick={() => setShowCookingMethodModal(false)}
              >
                H·ªßy
              </Button>
            </div>
          </>
        )}
      </Modal>
      {/* Payment Modal */}
      <Modal
        isOpen={showPaymentModal}
        onClose={() => setShowPaymentModal(false)}
        title={
          selectedTableDetail
            ? `üí∞ Thanh to√°n - ${selectedTableDetail.number}`
            : ""
        }
        size="large"
      >
        {selectedTableDetail && (
          <>
            {/* Bill Summary */}
            <div className="payment-section">
              <h4 className="payment-section-title">üìã Chi ti·∫øt h√≥a ƒë∆°n</h4>
              <div className="bill-summary">
                {selectedTableDetail.orders &&
                selectedTableDetail.orders.length > 0 ? (
                  selectedTableDetail.orders.map((order, index) => (
                    <div key={index} className="bill-item">
                      <div className="bill-item-info">
                        <div className="bill-item-name">
                          {order.item} x{order.quantity}
                        </div>
                        <div className="bill-item-details">
                          {order.cookingMethod
                            ? `üç≥ ${order.cookingMethod}`
                            : ""}
                          {order.customMethod
                            ? ` ‚Ä¢ ‚ú® ${order.customMethod}`
                            : ""}
                        </div>
                      </div>
                      <div className="bill-item-price">
                        {formatCurrency(order.subtotal)}
                      </div>
                    </div>
                  ))
                ) : (
                  <div className="empty-state">Kh√¥ng c√≥ m√≥n n√†o</div>
                )}
              </div>
            </div>
            {/* Payment Methods */}
            <div className="payment-section">
              <h4 className="payment-section-title">
                üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n
              </h4>
              <div className="payment-methods">
                {[
                  {
                    id: "cash",
                    icon: "üíµ",
                    name: "Ti·ªÅn m·∫∑t",
                    desc: "Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t",
                  },
                  {
                    id: "card",
                    icon: "üí≥",
                    name: "Th·∫ª ng√¢n h√†ng",
                    desc: "Visa, Mastercard, ATM",
                  },
                  {
                    id: "transfer",
                    icon: "üì±",
                    name: "Chuy·ªÉn kho·∫£n",
                    desc: "Banking, Momo, ZaloPay",
                  },
                ].map((method) => (
                  <div
                    key={method.id}
                    className={`payment-method ${
                      selectedPaymentMethod === method.id ? "selected" : ""
                    }`}
                    onClick={() => setSelectedPaymentMethod(method.id)}
                  >
                    <div className="payment-method-icon">{method.icon}</div>
                    <div className="payment-method-info">
                      <div className="payment-method-name">{method.name}</div>
                      <div className="payment-method-desc">{method.desc}</div>
                    </div>
                    <div className="payment-method-check">‚úì</div>
                  </div>
                ))}
              </div>
            </div>
            {/* Cash Payment Details */}
            {selectedPaymentMethod === "cash" && (
              <div className="payment-section">
                <h4 className="payment-section-title">
                  üíµ Thanh to√°n ti·ªÅn m·∫∑t
                </h4>
                <div className="cash-payment">
                  <div className="form-group">
                    <label className="form-label">Kh√°ch ƒë∆∞a</label>
                    <input
                      type="number"
                      className="form-input"
                      placeholder="0"
                      min="0"
                      value={customerPaid}
                      onChange={(e) => setCustomerPaid(e.target.value)}
                    />
                  </div>
                  <div className="change-display">
                    <div className="change-label">Ti·ªÅn th·ª´a</div>
                    <div
                      className={`change-amount ${
                        calculateChange() >= 0 ? "positive" : "negative"
                      }`}
                    >
                      {calculateChange() >= 0
                        ? formatCurrency(calculateChange())
                        : formatCurrency(Math.abs(calculateChange())) +
                          " (thi·∫øu)"}
                    </div>
                  </div>
                </div>
              </div>
            )}
            {/* Payment Summary */}
            <div className="payment-total">
              <div className="payment-total-row">
                <span>T·∫°m t√≠nh:</span>
                <span>{formatCurrency(selectedTableDetail.total)}</span>
              </div>
              <div className="payment-total-row">
                <span>Thu·∫ø VAT (10%):</span>
                <span>
                  {formatCurrency(Math.round(selectedTableDetail.total * 0.1))}
                </span>
              </div>
              <div className="payment-total-row total">
                <span>T·ªïng c·ªông:</span>
                <span>
                  {formatCurrency(
                    selectedTableDetail.total +
                      Math.round(selectedTableDetail.total * 0.1)
                  )}
                </span>
              </div>
            </div>
            <div className="modal-footer">
              <Button
                variant="secondary"
                onClick={() => setShowPaymentModal(false)}
              >
                H·ªßy
              </Button>
              <Button variant="success" onClick={processPaymentConfirm}>
                üí∞ X√°c nh·∫≠n thanh to√°n
              </Button>
            </div>
          </>
        )}
      </Modal>
    </div>
  );
};
export default TableManagement;
